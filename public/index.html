<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>PassFortress - Secure Password Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #0f172a;
        }
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .password-item {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slideIn {
            animation: slideInFromRight 0.3s ease;
        }
        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="text-gray-200">
    <div id="app"></div>

    <script>
        const API_BASE = window.location.origin;

        class PasswordManager {
            constructor() {
                this.state = {
                    screen: 'login', // login, register, app
                    user: null,
                    token: null,
                    passwords: [],
                    allPasswords: [], // Unfiltered passwords for search
                    showPassword: false,
                    generatedPassword: '',
                    newWebsite: '',
                    newUsername: '',
                    newPassword: '',
                    email: '',
                    password: '',
                    theme: localStorage.getItem('theme') || 'dark',
                    visiblePasswords: {}, // Track which passwords are visible
                    toastMessage: '',
                    toastType: '', // success, error, info
                    showGeneratedPassword: false, // Track visibility of generated password
                    searchQuery: '', // Search filter
                    passwordLength: 16, // Customizable password length
                    includeUppercase: true,
                    includeLowercase: true,
                    includeNumbers: true,
                    includeSymbols: true,
                    editingPasswordId: null, // Track which password is being edited
                    favorites: JSON.parse(localStorage.getItem('favorites') || '[]'), // Favorite passwords
                    showSettings: false, // Show password generator settings
                    enable2FA: false // Two-factor authentication flag
                    ,twoFAEnabled: false
                    ,show2FAModal: false
                    ,twoFAStage: 'idle' // idle | init | activate | verify
                    ,twoFASecret: ''
                    ,twoFAOtpAuth: ''
                    ,twoFATempToken: ''
                    ,twoFACode: ''
                    ,showDeleteConfirm: false
                    ,deleteTargetId: null
                };
                this.init();
            }

            init() {
                const savedToken = localStorage.getItem('token');
                const savedUser = localStorage.getItem('user');
                if (savedToken && savedUser) {
                    this.state.token = savedToken;
                    this.state.user = JSON.parse(savedUser);
                    this.state.screen = 'app';
                    this.loadPasswords();
                } else {
                    this.render();
                }
            }

            showToast(message, type = 'info') {
                this.state.toastMessage = message;
                this.state.toastType = type;
                this.render();
                setTimeout(() => {
                    this.state.toastMessage = '';
                    this.render();
                }, 3000);
            }

            async register() {
                if (!this.state.email || !this.state.password) {
                    this.showToast('Please fill in all fields', 'error');
                    return;
                }
                if (!this.validateEmail(this.state.email)) {
                    this.showToast('Invalid email format', 'error');
                    return;
                }
                if (!this.validatePasswordPolicy(this.state.password)) {
                    this.showToast('Password too weak (â‰¥8 & 3 types)', 'error');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/api/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.state.email, password: this.state.password })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        this.state.token = data.token;
                        this.state.user = data.user;
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        this.state.screen = 'app';
                        this.state.email = '';
                        this.state.password = '';
                        await this.loadPasswords();
                        this.render();
                    } else {
                        const error = await res.json();
                        this.showToast('Registration failed: ' + error.error, 'error');
                    }
                } catch (e) {
                    this.showToast('Error: ' + e.message, 'error');
                }
            }

            async login() {
                // æ¸…ç†ä¸Šä¸€æ¬¡çš„æç¤ºï¼Œé¿å…é”™è¯¯æ¶ˆæ¯åœ¨æˆåŠŸç™»å½•åæ®‹ç•™
                this.state.toastMessage = '';
                if (!this.state.email || !this.state.password) {
                    this.showToast('Please fill in all fields', 'error');
                    return;
                }
                if (!this.validateEmail(this.state.email)) {
                    this.showToast('Invalid email format', 'error');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.state.email, password: this.state.password })
                    });
                    const data = await res.json();
                    if (res.ok && data.require2FA) {
                        // è¿›å…¥äºŒæ¬¡éªŒè¯é˜¶æ®µ
                        this.state.twoFAStage = 'verify';
                        this.state.twoFATempToken = data.tempToken;
                        this.state.show2FAModal = true;
                        this.render();
                        return;
                    }
                    if (res.ok && data.token) {
                        this.state.token = data.token;
                        this.state.user = data.user;
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        this.state.screen = 'app';
                        this.state.email = '';
                        this.state.password = '';
                        // æˆåŠŸåç¡®ä¿æ¸…é™¤ä»»ä½•é”™è¯¯æç¤º
                        this.state.toastMessage = '';
                        await this.loadPasswords();
                        this.render();
                    } else {
                        this.showToast('Login failed: ' + (data.error || 'Unknown'), 'error');
                    }
                } catch (e) {
                    this.showToast('Error: ' + e.message, 'error');
                }
            }

            logout() {
                this.state.user = null;
                this.state.token = null;
                this.state.passwords = [];
                this.state.screen = 'login';
                this.state.email = '';
                this.state.password = '';
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                this.state.twoFAStage = 'idle';
                this.state.twoFATempToken = '';
                this.state.twoFASecret = '';
                this.render();
            }

            async loadPasswords() {
                try {
                    const res = await fetch(`${API_BASE}/api/passwords`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.state.allPasswords = await res.json();
                        this.filterPasswords();
                    }
                } catch (e) {
                    console.error('Failed to load passwords:', e);
                }
            }

            filterPasswords() {
                const query = this.state.searchQuery.toLowerCase();
                this.state.passwords = this.state.allPasswords.filter(p => 
                    p.website.toLowerCase().includes(query)
                );
            }

            searchPasswords(query) {
                this.state.searchQuery = query;
                this.filterPasswords();
                this.render();
            }

            calculatePasswordStrength(pwd) {
                let strength = 0;
                if (pwd.length >= 8) strength++;
                if (pwd.length >= 12) strength++;
                if (pwd.length >= 16) strength++;
                if (/[a-z]/.test(pwd)) strength++;
                if (/[A-Z]/.test(pwd)) strength++;
                if (/[0-9]/.test(pwd)) strength++;
                if (/[^a-zA-Z0-9]/.test(pwd)) strength++;
                
                if (strength <= 2) return { level: 'weak', color: 'red', text: 'Weak' };
                if (strength <= 5) return { level: 'medium', color: 'yellow', text: 'Medium' };
                return { level: 'strong', color: 'green', text: 'Strong' };
            }

            validateEmail(email) {
                return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
            }

            validatePasswordPolicy(pwd) {
                const categories = [/[a-z]/, /[A-Z]/, /[0-9]/, /[^a-zA-Z0-9]/].reduce((a,r)=> a + (r.test(pwd)?1:0),0);
                return pwd.length >= 8 && categories >= 3;
            }

            generatePassword() {
                let chars = '';
                if (this.state.includeUppercase) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                if (this.state.includeLowercase) chars += 'abcdefghijklmnopqrstuvwxyz';
                if (this.state.includeNumbers) chars += '0123456789';
                if (this.state.includeSymbols) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';
                
                if (chars.length === 0) {
                    this.showToast('Please select at least one character type', 'error');
                    return;
                }
                
                let pwd = '';
                for (let i = 0; i < this.state.passwordLength; i++) {
                    pwd += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                this.state.generatedPassword = pwd;
                this.state.showGeneratedPassword = false;
                this.render();
            }

            async savePassword() {
                if (!this.state.newWebsite || !this.state.newPassword) {
                    this.showToast('è¯·å¡«å†™ç½‘ç«™ä¸å¯†ç ', 'error');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/api/passwords`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ website: this.state.newWebsite, username: this.state.newUsername, password: this.state.newPassword })
                    });
                    if (res.ok) {
                        this.state.newWebsite = '';
                        this.state.newUsername = '';
                        this.state.newPassword = '';
                        this.state.generatedPassword = '';
                        await this.loadPasswords();
                        this.showToast('ä¿å­˜æˆåŠŸ âœ…', 'success');
                    } else {
                        this.showToast('ä¿å­˜å¤±è´¥', 'error');
                    }
                } catch (e) {
                    this.showToast('ä¿å­˜é”™è¯¯: ' + e.message, 'error');
                }
            }

            async deletePassword(id) {
                this.state.showDeleteConfirm = true;
                this.state.deleteTargetId = id;
                this.render();
            }

            async confirmDelete() {
                const id = this.state.deleteTargetId;
                if (!id) { this.state.showDeleteConfirm = false; this.render(); return; }
                try {
                    const res = await fetch(`${API_BASE}/api/passwords/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        await this.loadPasswords();
                        this.showToast('Deleted âœ…', 'success');
                    } else {
                        this.showToast('Delete failed', 'error');
                    }
                } catch (e) {
                    this.showToast('Error: ' + e.message, 'error');
                }
                this.state.showDeleteConfirm = false;
                this.state.deleteTargetId = null;
                this.render();
            }

            cancelDelete() {
                this.state.showDeleteConfirm = false;
                this.state.deleteTargetId = null;
                this.render();
            }

            startEditPassword(id, website, password, username = '') {
                this.state.editingPasswordId = id;
                this.state.newWebsite = website;
                this.state.newPassword = password;
                this.state.newUsername = username;
                this.render();
                setTimeout(() => {
                    document.getElementById('website')?.focus();
                }, 100);
            }

            async updatePassword() {
                if (!this.state.newWebsite || !this.state.newPassword) {
                    this.showToast('è¯·å¡«å†™ç½‘ç«™ä¸å¯†ç ', 'error');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/api/passwords/${this.state.editingPasswordId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ website: this.state.newWebsite, username: this.state.newUsername, password: this.state.newPassword })
                    });
                    if (res.ok) {
                        this.state.newWebsite = '';
                        this.state.newUsername = '';
                        this.state.newPassword = '';
                        this.state.editingPasswordId = null;
                        await this.loadPasswords();
                        this.showToast('å·²æ›´æ–° âœï¸', 'success');
                    } else {
                        this.showToast('æ›´æ–°å¤±è´¥', 'error');
                    }
                } catch (e) {
                    this.showToast('æ›´æ–°é”™è¯¯: ' + e.message, 'error');
                }
            }

            cancelEdit() {
                this.state.editingPasswordId = null;
                this.state.newWebsite = '';
                this.state.newPassword = '';
                this.render();
            }

            toggleFavorite(id) {
                const index = this.state.favorites.indexOf(id);
                if (index > -1) {
                    this.state.favorites.splice(index, 1);
                } else {
                    this.state.favorites.push(id);
                }
                localStorage.setItem('favorites', JSON.stringify(this.state.favorites));
                this.render();
            }

            exportPasswords() {
                const enriched = this.state.allPasswords.map(p => ({
                    id: p.id,
                    website: p.website,
                    username: p.username || '',
                    password: p.password,
                    created_at: p.created_at
                }));
                const data = JSON.stringify(enriched, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `passwords-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('å·²å¯¼å‡º ğŸ“¦', 'success');
            }

            importPasswords() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = async (e) => {
                    try {
                        const file = e.target.files[0];
                        const text = await file.text();
                        const imported = JSON.parse(text);
                        
                        for (const pwd of imported) {
                            await fetch(`${API_BASE}/api/passwords`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.state.token}`
                                },
                                body: JSON.stringify({ website: pwd.website, username: pwd.username || '', password: pwd.password })
                            });
                        }
                        
                        await this.loadPasswords();
                        this.showToast(`å¯¼å…¥ ${imported.length} æ¡å¯†ç  ğŸ“¥`, 'success');
                    } catch (e) {
                        this.showToast('å¯¼å…¥å¤±è´¥: ' + e.message, 'error');
                    }
                };
                input.click();
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', this.state.theme);
                document.body.className = this.state.theme === 'light' ? 'bg-gray-100 text-gray-900' : 'text-gray-200';
                this.render();
            }

            getPasswordAge(createdAt) {
                const days = Math.floor((Date.now() - new Date(createdAt)) / (1000 * 60 * 60 * 24));
                if (days > 90) return { text: `${days} days old`, color: 'red', warning: true };
                if (days > 60) return { text: `${days} days old`, color: 'yellow', warning: true };
                return { text: `${days} days old`, color: 'green', warning: false };
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('Copied to clipboard! ğŸ“‹', 'success');
                });
            }

            togglePasswordVisibility(id) {
                this.state.visiblePasswords[id] = !this.state.visiblePasswords[id];
                this.render();
            }

            toggleGeneratedPasswordVisibility() {
                this.state.showGeneratedPassword = !this.state.showGeneratedPassword;
                this.render();
            }

            useGeneratedPassword() {
                this.state.newPassword = this.state.generatedPassword;
                this.copyToClipboard(this.state.generatedPassword);
                this.render();
                // Auto-focus on website input after using generated password
                setTimeout(() => {
                    const websiteInput = document.getElementById('website');
                    if (websiteInput && !this.state.newWebsite) {
                        websiteInput.focus();
                    }
                }, 100);
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', this.state.theme);
                this.render();
            }

            render() {
                const app = document.getElementById('app');
                
                if (this.state.screen === 'login') {
                    app.innerHTML = this.renderLoginScreen();
                } else if (this.state.screen === 'register') {
                    app.innerHTML = this.renderRegisterScreen();
                } else {
                    app.innerHTML = this.renderAppScreen();
                }
                
                // Render toast if present
                if (this.state.toastMessage) {
                    const existingToast = document.getElementById('toast');
                    if (existingToast) existingToast.remove();
                    
                    const toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl text-white font-bold z-50 animate-slideIn ${
                        this.state.toastType === 'success' ? 'bg-gradient-to-r from-green-600 to-emerald-600' :
                        this.state.toastType === 'error' ? 'bg-gradient-to-r from-red-600 to-pink-600' :
                        'bg-gradient-to-r from-blue-600 to-purple-600'
                    }`;
                    toast.textContent = this.state.toastMessage;
                    document.body.appendChild(toast);
                }
                                // Delete confirmation modal
                                const existingModal = document.getElementById('delete-modal');
                                if (existingModal) existingModal.remove();
                                if (this.state.showDeleteConfirm) {
                                        const modal = document.createElement('div');
                                        modal.id = 'delete-modal';
                                        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
                                        modal.innerHTML = `
                                            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
                                            <div class="relative bg-[#0F1E2E] border border-[#F48120] rounded-xl p-6 w-[340px] shadow-2xl animate-slideIn">
                                                <h3 class="text-xl font-bold text-white mb-2">Confirm Deletion</h3>
                                                <p class="text-sm text-gray-300 mb-4">This action will permanently remove the password entry.</p>
                                                <div class="flex gap-3">
                                                    <button onclick="manager.confirmDelete()" class="flex-1 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white font-bold py-2 rounded-lg transition">Delete</button>
                                                    <button onclick="manager.cancelDelete()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded-lg transition">Cancel</button>
                                                </div>
                                            </div>`;
                                        document.body.appendChild(modal);
                                }
                                // 2FA æ¨¡æ€
                                const existing2FA = document.getElementById('twofa-modal');
                                if (existing2FA) existing2FA.remove();
                                if (this.state.show2FAModal) {
                                        const modal = document.createElement('div');
                                        modal.id = 'twofa-modal';
                                        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
                                        let bodyHTML = '';
                                        if (this.state.twoFAStage === 'init') {
                                                bodyHTML = `
                                                    <p class='text-sm text-gray-300 mb-3'>ä½¿ç”¨ <strong class='text-[#F48120]'>Google Authenticator</strong> æˆ–å…¶ä»–èº«ä»½éªŒè¯ App æ‰«æäºŒç»´ç ï¼š</p>
                                                    <div id='qrcode' class='flex justify-center mb-3'></div>
                                                    <p class='text-xs text-gray-400 text-center mb-2'>æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥ï¼š</p>
                                                    <div class='p-3 rounded bg-slate-700 font-mono break-all text-xs mb-3 select-all'>${this.state.twoFASecret}</div>
                                                    <input type='text' placeholder='6ä½éªŒè¯ç ' class='w-full bg-slate-700 text-white p-2 rounded mb-3 text-center tracking-widest' oninput='manager.state.twoFACode = this.value' />
                                                    <div class='flex gap-2'>
                                                        <button onclick='manager.activate2FA()' class='flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded'>ç¡®è®¤å¯ç”¨</button>
                                                        <button onclick='manager.close2FAModal()' class='flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded'>å–æ¶ˆ</button>
                                                    </div>`;
                                        } else if (this.state.twoFAStage === 'verify') {
                                                bodyHTML = `
                                                    <p class='text-sm text-gray-300 mb-4'>è¾“å…¥äºŒæ¬¡éªŒè¯ç å®Œæˆç™»å½•ã€‚</p>
                                                    <input type='text' placeholder='6ä½éªŒè¯ç ' class='w-full bg-slate-700 text-white p-2 rounded mb-3 text-center tracking-widest' oninput='manager.state.twoFACode = this.value' />
                                                    <div class='flex gap-2'>
                                                        <button onclick='manager.verifyLogin2FA()' class='flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded'>éªŒè¯</button>
                                                        <button onclick='manager.close2FAModal()' class='flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded'>å–æ¶ˆ</button>
                                                    </div>`;
                                        } else if (this.state.twoFAStage === 'disable') {
                                                bodyHTML = `
                                                    <p class='text-sm text-gray-300 mb-3'>è¾“å…¥å½“å‰éªŒè¯ç ä»¥å…³é—­äºŒæ¬¡éªŒè¯ã€‚</p>
                                                    <input type='text' placeholder='6ä½éªŒè¯ç ' class='w-full bg-slate-700 text-white p-2 rounded mb-3 text-center tracking-widest' oninput='manager.state.twoFACode = this.value' />
                                                    <div class='flex gap-2'>
                                                        <button onclick='manager.disable2FA()' class='flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded'>å…³é—­</button>
                                                        <button onclick='manager.close2FAModal()' class='flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded'>å–æ¶ˆ</button>
                                                    </div>`;
                                        }
                                        modal.innerHTML = `
                                            <div class='absolute inset-0 bg-black/60 backdrop-blur-sm'></div>
                                            <div class='relative bg-[#0F1E2E] border border-[#F48120] rounded-xl p-6 w-[360px] shadow-2xl animate-slideIn'>
                                                <h3 class='text-xl font-bold text-white mb-4'>äºŒæ¬¡éªŒè¯ ${this.state.twoFAStage==='verify'?'ç™»å½•':'è®¾ç½®'}</h3>
                                                ${bodyHTML}
                                            </div>`;
                                        document.body.appendChild(modal);
                                        if (this.state.twoFAStage === 'init') setTimeout(()=> this.generateQR(),50);
                                }
            }

            renderLoginScreen() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-6">
                        <div class="bg-slate-800 border border-purple-500 rounded-lg p-8 shadow-2xl max-w-md w-full">
                            <h1 class="text-4xl font-bold text-white mb-2 text-center">ğŸ” PassFortress</h1>
                            <p class="text-purple-300 text-center mb-8">Secure Password Manager</p>
                            <div class="space-y-4">
                                <input type="email" placeholder="Email" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="login-email" />
                                <input type="password" placeholder="Password" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="login-password" />
                                <button onclick="manager.login()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg transition">
                                    ğŸ”“ Login
                                </button>
                                <button onclick="manager.state.screen = 'register'; manager.render()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                    âœï¸ Create Account
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderRegisterScreen() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-6">
                        <div class="bg-slate-800 border border-purple-500 rounded-lg p-8 shadow-2xl max-w-md w-full">
                            <h1 class="text-4xl font-bold text-white mb-2 text-center">ğŸ” PassFortress</h1>
                            <p class="text-purple-300 text-center mb-8">Create Your Account</p>
                            <div class="space-y-4">
                                <input type="email" placeholder="Email" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="register-email" />
                                <input type="password" placeholder="Password" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="register-password" />
                                <button onclick="manager.register()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition">
                                    âœ… Register
                                </button>
                                <button onclick="manager.state.screen = 'login'; manager.render()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                    ğŸ”“ Back to Login
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAppScreen() {
                const strength = this.state.generatedPassword ? this.calculatePasswordStrength(this.state.generatedPassword) : null;
                const sortedPasswords = [...this.state.passwords].sort((a, b) => {
                    const aFav = this.state.favorites.includes(a.id);
                    const bFav = this.state.favorites.includes(b.id);
                    if (aFav && !bFav) return -1;
                    if (!aFav && bFav) return 1;
                    return 0;
                });
                
                return `
                    <div class="min-h-screen bg-gradient-to-br from-[#0F1E2E] via-slate-900 to-[#0F1E2E] p-6">
                        <div class="max-w-5xl mx-auto">
                            <!-- Header -->
                            <div class="flex justify-between items-center mb-8">
                                <div>
                                    <h1 class="text-5xl font-bold text-white mb-2">ğŸ” PassFortress</h1>
                                    <p class="text-gray-400 text-sm">æ¬¢è¿å›æ¥ï¼Œ<span class="text-[#F48120] font-semibold">${this.state.user.email}</span></p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="manager.toggleTheme()" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg transition shadow-lg" title="åˆ‡æ¢ä¸»é¢˜">
                                        ${this.state.theme === 'dark' ? 'â˜€ï¸ æµ…è‰²' : 'ğŸŒ™ æ·±è‰²'}
                                    </button>
                                    <button onclick="manager.exportPasswords()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg transition shadow-lg" title="å¯¼å‡ºå¯†ç ">
                                        ğŸ“¦ å¯¼å‡º
                                    </button>
                                    <button onclick="manager.importPasswords()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg transition shadow-lg" title="å¯¼å…¥å¯†ç ">
                                        ğŸ“¥ å¯¼å…¥
                                    </button>
                                    <button onclick="manager.open2FA()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg transition shadow-lg" title="åŒå› ç´ è®¤è¯">
                                        ${this.state.twoFAEnabled ? 'ğŸ”’ 2FA å·²å¯ç”¨' : 'ğŸ” å¯ç”¨ 2FA'}
                                    </button>
                                    <button onclick="manager.logout()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-lg transition shadow-lg" title="é€€å‡ºç™»å½•">ğŸšº é€€å‡º</button>
                                </div>
                            </div>
                            <div class="flex flex-col lg:flex-row gap-6">
                                <!-- Left: Search & Passwords List -->
                                <div class="flex-1 space-y-6">
                                    <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-2xl h-full">
                                        <div class="flex justify-between items-center mb-4">
                                            <h2 class="text-2xl font-bold text-white">ğŸ”‘ å·²ä¿å­˜å¯†ç  (${this.state.passwords.length})</h2>
                                        </div>
                                        <input type="text" placeholder="ğŸ” æœç´¢å¯†ç ..." value="${this.state.searchQuery}" 
                                            oninput="manager.searchPasswords(this.value)" 
                                            class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500 mb-4" />
                                        <div class="space-y-3 max-h-[560px] overflow-y-auto pr-1">
                                            ${this.state.passwords.length === 0 ? 
                                                '<p class="text-gray-400 text-center py-8">æš‚æ— å¯†ç ã€‚</p>' : 
                                                sortedPasswords.map(p => {
                                                    const age = this.getPasswordAge(p.created_at);
                                                    const isFavorite = this.state.favorites.includes(p.id);
                                                    return `
                                                    <div class="password-item bg-slate-700 p-4 rounded-lg border ${isFavorite ? 'border-yellow-500' : 'border-purple-500'} transition-all">
                                                        <div class="flex justify-between items-start mb-2">
                                                            <div class="flex-1">
                                                                <div class="flex items-center gap-2">
                                                                    <button onclick="manager.toggleFavorite(${p.id})" class="text-2xl" title="${isFavorite ? 'ç§»å‡ºæ”¶è—' : 'åŠ å…¥æ”¶è—'}">
                                                                        ${isFavorite ? 'â­' : 'â˜†'}
                                                                    </button>
                                                                    <p class="font-bold text-purple-300 text-lg truncate max-w-[180px]" title="${p.website}">${p.website}</p>
                                                                </div>
                                                                <p class="text-sm text-gray-400 font-mono ml-8 break-all">${this.state.visiblePasswords[p.id] ? p.password : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}</p>
                                                                ${p.username ? `<p class='text-xs text-blue-300 ml-8 break-all'>ğŸ‘¤ ${p.username}</p>` : ''}
                                                                <div class="flex items-center gap-3 mt-2 ml-8">
                                                                    <p class="text-xs text-gray-500">ğŸ“… ${new Date(p.created_at).toLocaleDateString()}</p>
                                                                    <p class="text-xs" style="color: ${age.color === 'red' ? '#f87171' : age.color === 'yellow' ? '#facc15' : '#4ade80'}">${age.warning ? 'âš ï¸ ' : ''}${age.text}</p>
                                                                </div>
                                                            </div>
                                                            <div class="flex gap-1">
                                                                <button onclick="manager.togglePasswordVisibility(${p.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg transition text-sm" title="${this.state.visiblePasswords[p.id] ? 'éšè—' : 'æ˜¾ç¤º'}">
                                                                    ${this.state.visiblePasswords[p.id] ? 'ğŸ‘ï¸' : 'ğŸ”’'}
                                                                </button>
                                                                <button onclick="manager.copyToClipboard('${p.password}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition text-sm" title="å¤åˆ¶">
                                                                    ğŸ“‹
                                                                </button>
                                                                <button onclick="manager.startEditPassword(${p.id}, '${p.website}', '${p.password}', '${(p.username||'').replace(/'/g, "&#39;")}')" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-2 rounded-lg transition text-sm" title="ç¼–è¾‘">
                                                                    âœï¸
                                                                </button>
                                                                <button onclick="manager.deletePassword(${p.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg transition text-sm" title="åˆ é™¤">
                                                                    ğŸ—‘ï¸
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `}).join('')
                                            }
                                        </div>
                                    </div>
                                </div>
                                <!-- Right: Generator + Save/Edit -->
                                <div class="w-full lg:w-[420px] space-y-6">
                                    <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-2xl">
                                        <div class="flex justify-between items-center mb-4">
                                            <h2 class="text-2xl font-bold text-white">ğŸ² ç”Ÿæˆå¼ºå¯†ç </h2>
                                            <button onclick="manager.state.showSettings = !manager.state.showSettings; manager.render()" class="text-purple-300 hover:text-purple-100">
                                                âš™ï¸ è®¾ç½®
                                            </button>
                                        </div>
                                        ${this.state.showSettings ? `
                                            <div class="bg-slate-700 p-4 rounded-lg mb-4 space-y-3">
                                                <div class="flex items-center justify-between">
                                                    <label class="text-white">é•¿åº¦: ${this.state.passwordLength}</label>
                                                    <input type="range" min="8" max="32" value="${this.state.passwordLength}" onchange="manager.state.passwordLength = parseInt(this.value); manager.render()" class="w-48" />
                                                </div>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeUppercase ? 'checked' : ''} onchange="manager.state.includeUppercase = this.checked; manager.render()" class="mr-2" /> å¤§å†™ (A-Z)
                                                    </label>
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeLowercase ? 'checked' : ''} onchange="manager.state.includeLowercase = this.checked; manager.render()" class="mr-2" /> å°å†™ (a-z)
                                                    </label>
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeNumbers ? 'checked' : ''} onchange="manager.state.includeNumbers = this.checked; manager.render()" class="mr-2" /> æ•°å­— (0-9)
                                                    </label>
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeSymbols ? 'checked' : ''} onchange="manager.state.includeSymbols = this.checked; manager.render()" class="mr-2" /> ç¬¦å· (!@#)
                                                    </label>
                                                </div>
                                            </div>
                                        ` : ''}
                                        <button onclick="manager.generatePassword()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg transition mb-3">ğŸ² ç”Ÿæˆå¯†ç </button>
                                        ${this.state.generatedPassword ? `
                                            <div class="space-y-2">
                                                ${strength ? `
                                                    <div class="flex items-center gap-2">
                                                        <div class="flex-1 bg-slate-700 rounded-full h-2">
                                                            <div class="h-2 rounded-full transition-all" style="width: ${strength.level === 'weak' ? '33%' : strength.level === 'medium' ? '66%' : '100%'}; background-color: ${strength.color === 'red' ? '#ef4444' : strength.color === 'yellow' ? '#eab308' : '#22c55e'}"></div>
                                                        </div>
                                                        <span class="font-bold text-sm" style="color: ${strength.color === 'red' ? '#f87171' : strength.color === 'yellow' ? '#facc15' : '#4ade80'}">${strength.text}</span>
                                                    </div>
                                                ` : ''}
                                                <div class="flex gap-2">
                                                    <input type="${this.state.showGeneratedPassword ? 'text' : 'password'}" value="${this.state.generatedPassword}" readonly class="flex-1 bg-slate-700 text-white p-3 rounded-lg border border-purple-500 font-mono" />
                                                    <button onclick="manager.toggleGeneratedPasswordVisibility()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition" title="${this.state.showGeneratedPassword ? 'éšè—' : 'æ˜¾ç¤º'}">${this.state.showGeneratedPassword ? 'ğŸ‘ï¸' : 'ğŸ”’'}</button>
                                                    <button onclick="manager.copyToClipboard('${this.state.generatedPassword}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition" title="å¤åˆ¶">ğŸ“‹</button>
                                                    <button onclick="manager.useGeneratedPassword()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition" title="ä½¿ç”¨">âœ…</button>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-2xl">
                                        <h2 class="text-2xl font-bold text-white mb-4">${this.state.editingPasswordId ? 'âœï¸ ç¼–è¾‘å¯†ç ' : 'ğŸ’¾ ä¿å­˜å¯†ç '}</h2>
                                        <div class="space-y-3">
                                            <div class="flex gap-2">
                                                <input type="text" placeholder="ç½‘ç«™ (ä¾‹å¦‚ï¼šgmail.com)" value="${this.state.newWebsite}" class="w-1/2 bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="website" />
                                                <input type="text" placeholder="ç”¨æˆ·å (ä¾‹å¦‚ï¼šuser123)" value="${this.state.newUsername}" class="w-1/2 bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="username" oninput="manager.state.newUsername=this.value" />
                                            </div>
                                            <input type="password" placeholder="å¯†ç " value="${this.state.newPassword}" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500 font-mono" id="password" />
                                            ${this.state.editingPasswordId ? `
                                                <div class="flex gap-2">
                                                    <button onclick="manager.updatePassword()" class="flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition">âœï¸ æ›´æ–°å¯†ç </button>
                                                    <button onclick="manager.cancelEdit()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-6 rounded-lg transition">âŒ å–æ¶ˆ</button>
                                                </div>
                                            ` : `
                                                <button onclick="manager.savePassword()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition">ğŸ’¾ ä¿å­˜å¯†ç </button>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        const manager = new PasswordManager();

        // Update input bindings
        setInterval(() => {
            const websiteInput = document.getElementById('website');
            const passwordInput = document.getElementById('password');
            const loginEmail = document.getElementById('login-email');
            const loginPassword = document.getElementById('login-password');
            const registerEmail = document.getElementById('register-email');
            const registerPassword = document.getElementById('register-password');

            if (websiteInput) websiteInput.addEventListener('input', (e) => { manager.state.newWebsite = e.target.value; });
            if (passwordInput) passwordInput.addEventListener('input', (e) => { manager.state.newPassword = e.target.value; });
            if (loginEmail) loginEmail.addEventListener('input', (e) => { manager.state.email = e.target.value; });
            if (loginPassword) loginPassword.addEventListener('input', (e) => { manager.state.password = e.target.value; });
            if (registerEmail) registerEmail.addEventListener('input', (e) => { manager.state.email = e.target.value; });
            if (registerPassword) registerPassword.addEventListener('input', (e) => { manager.state.password = e.target.value; });
        }, 100);

        // 2FA è¾…åŠ©å‡½æ•°
        PasswordManager.prototype.open2FA = async function() {
            try {
                // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å¯ç”¨
                const res = await fetch(`${API_BASE}/api/auth/login`, { method:'OPTIONS' }) // å ä½å¯æ‰©å±•
            } catch {}
            if (!this.state.twoFAEnabled) {
                // åˆå§‹åŒ–é˜¶æ®µ
                this.state.twoFAStage = 'init';
                this.showToast('ç”ŸæˆäºŒæ¬¡éªŒè¯å¯†é’¥...', 'info');
                try {
                    const r = await fetch(`${API_BASE}/api/auth/2fa/init`, { method:'POST', headers:{'Authorization':`Bearer ${this.state.token}`}});
                    const data = await r.json();
                    if (r.ok) {
                        this.state.twoFASecret = data.secret;
                        this.state.twoFAOtpAuth = data.otpauth;
                        this.state.show2FAModal = true;
                        this.render();
                    } else {
                        this.showToast(data.error || 'Init failed','error');
                    }
                } catch(e){ this.showToast(e.message,'error'); }
            } else {
                this.state.twoFAStage = 'disable';
                this.state.show2FAModal = true;
                this.render();
            }
        }

        PasswordManager.prototype.activate2FA = async function() {
            if (!this.state.twoFACode) { this.showToast('è¯·è¾“å…¥éªŒè¯ç ','error'); return; }
            try {
                const r = await fetch(`${API_BASE}/api/auth/2fa/activate`, {
                    method:'POST',
                    headers:{'Authorization':`Bearer ${this.state.token}`, 'Content-Type':'application/json'},
                    body: JSON.stringify({ code: this.state.twoFACode })
                });
                const data = await r.json();
                if (r.ok) {
                    this.state.twoFAEnabled = true;
                    this.state.show2FAModal = false;
                    this.state.twoFAStage = 'idle';
                    this.state.twoFACode='';
                    this.showToast('2FA å·²å¯ç”¨','success');
                    this.render();
                } else this.showToast(data.error || 'å¯ç”¨å¤±è´¥','error');
            } catch(e){ this.showToast(e.message,'error'); }
        }

        PasswordManager.prototype.verifyLogin2FA = async function() {
            if (!this.state.twoFACode) { this.showToast('è¯·è¾“å…¥éªŒè¯ç ','error'); return; }
            try {
                const r = await fetch(`${API_BASE}/api/auth/2fa/verify`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ tempToken: this.state.twoFATempToken, code: this.state.twoFACode })
                });
                const data = await r.json();
                if (r.ok && data.token) {
                    this.state.token = data.token;
                    this.state.user = data.user;
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    this.state.screen='app';
                    this.state.show2FAModal=false;
                    this.state.twoFAStage='idle';
                    this.state.twoFATempToken='';
                    this.state.twoFACode='';
                    this.showToast('ç™»å½•æˆåŠŸ','success');
                    await this.loadPasswords();
                    this.render();
                } else this.showToast(data.error || 'éªŒè¯å¤±è´¥','error');
            } catch(e){ this.showToast(e.message,'error'); }
        }

        PasswordManager.prototype.disable2FA = async function() {
            if (!this.state.twoFACode) { this.showToast('è¯·è¾“å…¥éªŒè¯ç ','error'); return; }
            try {
                const r = await fetch(`${API_BASE}/api/auth/2fa/disable`, {
                    method:'POST', headers:{'Authorization':`Bearer ${this.state.token}`, 'Content-Type':'application/json'},
                    body: JSON.stringify({ code: this.state.twoFACode })
                });
                const data = await r.json();
                if (r.ok) {
                    this.state.twoFAEnabled = false;
                    this.state.show2FAModal=false;
                    this.state.twoFAStage='idle';
                    this.state.twoFACode='';
                    this.showToast('2FA å·²å…³é—­','success');
                    this.render();
                } else this.showToast(data.error || 'å…³é—­å¤±è´¥','error');
            } catch(e){ this.showToast(e.message,'error'); }
        }

        PasswordManager.prototype.close2FAModal = function(){
            this.state.show2FAModal=false; this.state.twoFAStage='idle'; this.state.twoFACode=''; this.render();
        }

        // ä½¿ç”¨ QRCode.js ç”Ÿæˆæ ‡å‡†äºŒç»´ç  (å…¼å®¹ Google Authenticator)
        PasswordManager.prototype.generateQR = function() {
            const container = document.getElementById('qrcode');
            if (!container || !this.state.twoFAOtpAuth) return;
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            try {
                // ç”ŸæˆäºŒç»´ç 
                new QRCode(container, {
                    text: this.state.twoFAOtpAuth,
                    width: 200,
                    height: 200,
                    colorDark: '#0F1E2E',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                // é™çº§æ˜¾ç¤º URI
                container.innerHTML = `<div class='text-xs text-gray-400 p-2 bg-slate-700 rounded break-all'>${this.state.twoFAOtpAuth}</div>`;
            }
        }
    </script>
</body>
</html>
